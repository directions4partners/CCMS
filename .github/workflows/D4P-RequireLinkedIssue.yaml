name: '_Require linked issue'

on:
  pull_request_target:
    types: [opened, edited, reopened, synchronize]

jobs:
  require-linked-issue:
    if: github.event.pull_request.base.repo.full_name == 'directions4partners/CCMS'
    runs-on: ubuntu-latest

    steps:
      - name: Check PR for linked issues (metadata)
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          Write-Host "Checking linked issues via GraphQL..."
          Write-Host "Repo: $env:OWNER/$env:REPO_NAME  PR: #$env:PR_NUMBER"

          $query = @"
          query {
            repository(owner: "$($env:OWNER)", name: "$($env:REPO_NAME)") {
              pullRequest(number: $($env:PR_NUMBER)) {
                closingIssuesReferences(first: 10) {
                  totalCount
                }
              }
            }
          }
          "@

          $body = @{ query = $query } | ConvertTo-Json -Compress

          $headers = @{
            Authorization  = "Bearer $env:GH_TOKEN"
            "Content-Type" = "application/json"
          }

          $response = Invoke-RestMethod `
            -Uri "https://api.github.com/graphql" `
            -Method Post `
            -Headers $headers `
            -Body $body

          $count = $response.data.repository.pullRequest.closingIssuesReferences.totalCount

          if ($count -gt 0) {
            Write-Host "✅ Found $count linked issue(s) in PR metadata."
            exit 0
          }

          Write-Error "❌ No linked issues found in PR metadata. Please link an issue using the PR sidebar or closing keywords (e.g., 'Fixes #123')."
          exit 1
