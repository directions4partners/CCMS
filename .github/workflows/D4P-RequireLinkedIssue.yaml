name: '_Require linked issue'

on:
  pull_request_target:
    types: [opened, edited, reopened, synchronize]

jobs:
  require-linked-issue:
    if: github.event.pull_request.base.repo.full_name == 'directions4partners/CCMS' && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Check PR for linked issues (metadata)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "Checking linked issues via GraphQL..."

          QUERY=$(cat <<EOF
          query {
            repository(owner: "$(echo $REPO | cut -d/ -f1)", name: "$(echo $REPO | cut -d/ -f2)") {
              pullRequest(number: $PR_NUMBER) {
                closingIssuesReferences(first: 10) {
                  totalCount
                }
              }
            }
          }
          EOF
          )

          RESPONSE=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"$QUERY\"}" \
            https://api.github.com/graphql)

          echo "$RESPONSE"
          COUNT=$(echo "$RESPONSE" | jq -r '.data.repository.pullRequest.closingIssuesReferences.totalCount')

          if [ "$COUNT" -gt 0 ]; then
            echo "✅ Found $COUNT linked issue(s) in PR metadata."
          else
            echo "❌ No linked issues found in PR metadata."
            echo "Please link an issue using the PR sidebar or issue keywords."
            exit 1
          fi
